<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    
    <meta name="referrer" content="no-referrer-when-downgrade">
    
    <meta name="renderer" content="webkit"/>
    <meta name="force-rendering" content="webkit"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <script>if (/*@cc_on!@*/false || (!!window.MSInputMethodContext && !!document.documentMode)) window.location.href="https://support.dmeng.net/upgrade-your-browser.html?referrer="+encodeURIComponent(window.location.href); </script>
    
    
        <link rel="preload" crossorigin="crossorigin" href="/fonts/roboto/Roboto-Regular.woff2" as="font">
        <link rel="preload" crossorigin="crossorigin" href="/fonts/roboto/Roboto-Bold.woff2" as="font">
    
    
    
        <link rel="shortcut icon" href="/ios.github.io/./././images/userImage.JPG">
    

    
    
        
<link rel="stylesheet" href="/ios.github.io/css/mdui.min.v1.0.0.css">

    
    
<link rel="stylesheet" href="/ios.github.io/css/main.css">
<link rel="stylesheet" href="/ios.github.io/css/iconfont.css">


    
    

    
        <script data-ad-client="ca-" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    












          


    
    
    <title>
        
            swift学习日记(九) | 猪会飞的博客
        
    </title>
    
    
<meta name="generator" content="Hexo 8.1.1"></head>
<body class="mdui-drawer-body-left mdui-appbar-with-toolbar mdui-theme-primary-teal mdui-theme-accent-blue">
  
  <header class="mdui-appbar mdui-appbar-fixed">
  <div id="toolbar" class="mdui-toolbar mdui-color-theme">
    <button class="mdui-btn mdui-btn-icon" mdui-drawer="{target: '#sidebar', swipe: true}"><i class="iconfont icon-menu"></i></button>
    <a href="/ios.github.io/" class="mdui-typo-headline">猪会飞的博客</a>
    <a href="/ios.github.io/" class="header-subtitle mdui-typo-headline"></a>
    <div class="mdui-toolbar-spacer"></div>
    <button class="mdui-btn mdui-btn-icon" mdui-dialog="{target: '#search'}" mdui-tooltip="{content: 'search'}"><i class="iconfont icon-search"></i></button>
  </div>
</header>

<div class="mdui-dialog" id="search">
  
    <div class="search-form">
      <input type="search" class="search-form-input" placeholder="请输入关键字" onfocus="listenSearchFunc()">
    </div>
    <div class="search-result" data-resource="/ios.github.io/search.xml"></div>
  
</div>

  <aside id="sidebar" class="mdui-drawer">
    <div class="mdui-tab" mdui-tab>
        <a href="#sidebar-tab1" id="sidebartab" class="mdui-ripple mdui-tab-active">站点概览</a>
        <a href="#sidebar-tab2" id="sidebartab" class="mdui-ripple">关于</a>
    </div>

    
    <div id="sidebar-tab1" class="mdui-p-a-1">
        <div class="mdui-list">
            
                
                <a href="/ios.github.io/" class="mdui-list-item mdui-ripple">
                    <div class="mdui-list-item-icon">
                        <i class="iconfont icon-home"></i>
                    </div>
                    <div class="mdui-list-item-content">主页</div>
                </a>
            
                
                <a href="/ios.github.io/archives/" class="mdui-list-item mdui-ripple">
                    <div class="mdui-list-item-icon">
                        <i class="iconfont icon-archive"></i>
                    </div>
                    <div class="mdui-list-item-content">归档</div>
                </a>
            
                
                <a href="/ios.github.io/tags/" class="mdui-list-item mdui-ripple">
                    <div class="mdui-list-item-icon">
                        <i class="iconfont icon-bookmark"></i>
                    </div>
                    <div class="mdui-list-item-content">标签</div>
                </a>
            
                
                <a href="/ios.github.io/about/" class="mdui-list-item mdui-ripple">
                    <div class="mdui-list-item-icon">
                        <i class="iconfont icon-user"></i>
                    </div>
                    <div class="mdui-list-item-content">关于</div>
                </a>
            
            <div class="mdui-list-item mdui-ripple">
                <div class="mdui-list-item-icon">
                    <i class="iconfont icon-moon"></i>
                </div>
                <div class="mdui-list-item-content">夜间模式</div>
                <label class="mdui-switch" id="darkmode">
                  <input type="checkbox" id="nightmode_switch"/>
                  <i class="mdui-switch-icon"></i>
                </label>
            </div>           
        </div>
    </div>

    
    <div id="sidebar-tab2" class="mdui-p-a-1">
        <div class="sidebar-overview">
            <div class="sidebar-avatar">
                
                    <img src="/ios.github.io/./././images/userImage.JPG"/>
                
            </div>
            <div class="sidebar-author-name">猪会飞</div>
            <div class="sidebar-description"></div>
        </div>
        <div class="sidebar-links">
            
                
                <div class="mdui-chip">
                    <span class="mdui-chip-icon"><i class="iconfont icon-mail"></i></span>
                    <a href="mailto:2839029331@qq.com" class="mdui-chip-title">E-Mail</a>
                </div>
            
                
                <div class="mdui-chip">
                    <span class="mdui-chip-icon"><i class="iconfont icon-github"></i></span>
                    <a target="_blank" rel="noopener" href="https://github.com/YCCIT123" class="mdui-chip-title">GitHub</a>
                </div>
            
        </div>
        <ul class="mdui-list" mdui-collapse="{accordion: true}">
            <li class="mdui-collapse-item">
                <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
                    <div class="mdui-list-item-icon">
                        <i class="iconfont icon-link"></i>
                    </div>
                    <div class="mdui-list-item-content">友情链接</div>
                    <div class="mdui-collapse-item-arrow">
                        <i class="mdui-list-item-icon iconfont icon-angle-down"></i>
                    </div>
                </div>
                <ul id="linksList" class="mdui-collapse-item-body mdui-list mdui-list-dense">
                    
                        <a target="_blank" rel="noopener" href="https://garybear.cn/hexo-theme-meadow/" class="mdui-list-item mdui-ripple">
                            Meadow说明文档
                        </a>
                    
                </ul>
            </li>
        </ul>
    </div>

    <div class="mdui-divider"></div>
    
    
</aside>
  
  <main id="main-contain" class="mdui-container mdui-m-t-5">
    <article id="article" class="mdui-card mdui-p-b-2 mdui-m-b-5">
  <header class="mdui-card-media">
    
    
      <div class="post-header"> 
  <a class="post-header-title" href="/ios.github.io/2025/12/14/swift%E5%AD%A6%E4%B9%A0%E6%97%A5%E8%AE%B0%EF%BC%88%E4%B9%9D%EF%BC%89/">swift学习日记(九)</a>
  <div class="post-header-meta">
    <span>
      <span class="iconfont icon-calendar"></span>
      发布于:&nbsp;2025-12-14
    </span>
    <span>
      <span class="iconfont icon-calendar-check"></span>
      更新于:&nbsp;2025-12-04
    </span>
    <span>
      <span class="iconfont icon-folder"></span>
      分类于:&nbsp;
    </span>
    
  </div>
</div>   
    



    
    
    <div class="mdui-card-menu">
    
      <button class="mdui-btn mdui-btn-icon mdui-text-color-teal" mdui-menu="{target: '#share_menu', align: 'right'}"><i class="iconfont icon-share"></i></button>
      <ul class="mdui-menu" id="share_menu">
        <li class="mdui-menu-item">
          <a href="http://service.weibo.com/share/share.php?appkey=&title=swift学习日记(九)&url=https://yccit123.github.io/ios.github.io/2025/12/14/swift%E5%AD%A6%E4%B9%A0%E6%97%A5%E8%AE%B0%EF%BC%88%E4%B9%9D%EF%BC%89/&pic=https://yccit123.github.io/ios.github.io/ios.github.io/./././images/userImage.JPG&searchPic=false&style=simple" target="_blank" class="mdui-ripple">分享到 Weibo</a>
        </li>
        <li class="mdui-menu-item">
          <a href="https://twitter.com/intent/tweet?text=swift学习日记(九)&url=https://yccit123.github.io/ios.github.io/2025/12/14/swift%E5%AD%A6%E4%B9%A0%E6%97%A5%E8%AE%B0%EF%BC%88%E4%B9%9D%EF%BC%89/&via=猪会飞" target="_blank" class="mdui-ripple">分享到 Twitter</a>
        </li>
        <li class="mdui-menu-item">
          <a href="https://www.facebook.com/sharer/sharer.php?u=https://yccit123.github.io/ios.github.io/2025/12/14/swift%E5%AD%A6%E4%B9%A0%E6%97%A5%E8%AE%B0%EF%BC%88%E4%B9%9D%EF%BC%89/" target="_blank" class="mdui-ripple">分享到 Facebook</a>
        </li>
        <li class="mdui-menu-item">
          <a href="https://plus.google.com/share?url=https://yccit123.github.io/ios.github.io/2025/12/14/swift%E5%AD%A6%E4%B9%A0%E6%97%A5%E8%AE%B0%EF%BC%88%E4%B9%9D%EF%BC%89/" target="_blank" class="mdui-ripple">分享到 Google+</a>
        </li>
        <li class="mdui-menu-item">
          <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://yccit123.github.io/ios.github.io/2025/12/14/swift%E5%AD%A6%E4%B9%A0%E6%97%A5%E8%AE%B0%EF%BC%88%E4%B9%9D%EF%BC%89/&title=swift学习日记(九)" target="_blank" class="mdui-ripple">分享到 LinkedIn</a>
        </li>
        <li class="mdui-menu-item">
          <a href="http://connect.qq.com/widget/shareqq/index.html?site=猪会飞的博客&title=swift学习日记(九)&summary=&pics=https://yccit123.github.io/ios.github.io/ios.github.io/./././images/userImage.JPG&url=https://yccit123.github.io/ios.github.io/2025/12/14/swift%E5%AD%A6%E4%B9%A0%E6%97%A5%E8%AE%B0%EF%BC%88%E4%B9%9D%EF%BC%89/" target="_blank" class="mdui-ripple">分享到 QQ</a>
        </li>
        <li class="mdui-menu-item">
          <a href="https://telegram.me/share/url?url=https://yccit123.github.io/ios.github.io/2025/12/14/swift%E5%AD%A6%E4%B9%A0%E6%97%A5%E8%AE%B0%EF%BC%88%E4%B9%9D%EF%BC%89/&text=swift学习日记(九)" target="_blank" class="mdui-ripple">分享到 Telegram</a>
        </li>
      </ul>
    
  </div>
  </header>
  
  
  
  
  <div class="post-tags">
    
      <i class="iconfont icon-tag">
        <a rel="tag" href = /ios.github.io/tags/swift/ >swift</a>
      </i>
    
  </div>

  
  <div class="mdui-card-content mdui-typo mdui-p-x-4">
    <h1 id="Swift学习日记（九）：内存管理"><a href="#Swift学习日记（九）：内存管理" class="headerlink" title="Swift学习日记（九）：内存管理"></a>Swift学习日记（九）：内存管理</h1><h2 id="一、引言"><a href="#一、引言" class="headerlink" title="一、引言"></a>一、引言</h2><p>在上一篇学习日记中，我们学习了Swift的错误处理机制，它允许我们在程序运行时处理可能出现的错误情况，使代码更加健壮和可靠。在这篇日记中，我们将探讨Swift的内存管理机制。内存管理是编程中至关重要的一部分，它直接影响应用的性能和稳定性。Swift采用自动引用计数（ARC）机制来管理内存，这使得我们可以专注于代码逻辑，而不需要手动管理内存。</p>
<h2 id="二、内存管理的基本概念"><a href="#二、内存管理的基本概念" class="headerlink" title="二、内存管理的基本概念"></a>二、内存管理的基本概念</h2><p>内存管理是指在程序运行时，对内存的分配、使用和释放进行管理。在Swift中，内存管理主要涉及以下几个概念：</p>
<ol>
<li><p><strong>堆内存与栈内存</strong>：</p>
<ul>
<li><strong>栈内存</strong>：用于存储临时变量和函数调用信息，由系统自动管理，分配和释放速度快。</li>
<li><strong>堆内存</strong>：用于存储对象实例和较大的数据结构，由开发者或自动内存管理系统管理，分配和释放速度相对较慢。</li>
</ul>
</li>
<li><p><strong>值类型与引用类型</strong>：</p>
<ul>
<li><strong>值类型</strong>：包括结构体、枚举和基本数据类型（如Int、Double、String等），它们存储在栈内存中，赋值时会进行值拷贝。</li>
<li><strong>引用类型</strong>：包括类和闭包，它们存储在堆内存中，赋值时会进行引用拷贝。</li>
</ul>
</li>
<li><p><strong>生命周期</strong>：对象的生命周期是指从对象创建到对象被销毁的过程。在Swift中，对象的生命周期由自动引用计数（ARC）管理。</p>
</li>
</ol>
<!-- CATEGORY: 内存管理 -->
<!-- INTERVIEW_TOPIC: 自动引用计数 -->
<!-- HIGH_FREQUENCY_INTERVIEW: ARC工作原理 -->

<h2 id="三、自动引用计数（ARC）"><a href="#三、自动引用计数（ARC）" class="headerlink" title="三、自动引用计数（ARC）"></a>三、自动引用计数（ARC）</h2><p>Swift使用自动引用计数（Automatic Reference Counting，简称ARC）机制来管理类实例的内存。ARC会自动跟踪和管理对象的引用计数，当对象的引用计数为0时，ARC会自动释放对象的内存。</p>
<h3 id="1-ARC的工作原理"><a href="#1-ARC的工作原理" class="headerlink" title="1. ARC的工作原理"></a>1. ARC的工作原理</h3><ul>
<li>当创建一个类实例时，ARC会为该实例分配一块内存，并将引用计数设置为1。</li>
<li>当一个新的引用指向该实例时，ARC会将引用计数加1。</li>
<li>当一个引用不再指向该实例时，ARC会将引用计数减1。</li>
<li>当引用计数变为0时，ARC会释放该实例的内存。</li>
</ul>
<h3 id="2-ARC的基本示例"><a href="#2-ARC的基本示例" class="headerlink" title="2. ARC的基本示例"></a>2. ARC的基本示例</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义一个类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> name: <span class="type">String</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(<span class="params">name</span>: <span class="type">String</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.name <span class="operator">=</span> name</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;<span class="subst">\(name)</span> 被初始化&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">deinit</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;<span class="subst">\(name)</span> 被销毁&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个Person实例，引用计数为1</span></span><br><span class="line"><span class="keyword">var</span> person1: <span class="type">Person</span>? <span class="operator">=</span> <span class="type">Person</span>(name: <span class="string">&quot;张三&quot;</span>)</span><br><span class="line"><span class="comment">// 输出：张三 被初始化</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个新的引用，引用计数为2</span></span><br><span class="line"><span class="keyword">var</span> person2: <span class="type">Person</span>? <span class="operator">=</span> person1</span><br><span class="line"></span><br><span class="line"><span class="comment">// 释放person1引用，引用计数为1</span></span><br><span class="line">person1 <span class="operator">=</span> <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 释放person2引用，引用计数为0，实例被销毁</span></span><br><span class="line">person2 <span class="operator">=</span> <span class="literal">nil</span></span><br><span class="line"><span class="comment">// 输出：张三 被销毁</span></span><br></pre></td></tr></table></figure>

<!-- INTERVIEW_TOPIC: 引用类型 -->
<!-- HIGH_FREQUENCY_INTERVIEW: 强引用、弱引用、无主引用 -->

<h2 id="四、引用类型的引用类型"><a href="#四、引用类型的引用类型" class="headerlink" title="四、引用类型的引用类型"></a>四、引用类型的引用类型</h2><p>在Swift中，引用类型有三种引用类型：强引用（Strong Reference）、弱引用（Weak Reference）和无主引用（Unowned Reference）。</p>
<h3 id="1-强引用"><a href="#1-强引用" class="headerlink" title="1. 强引用"></a>1. 强引用</h3><p>强引用是默认的引用类型，它会增加对象的引用计数。当一个对象的强引用计数为0时，对象会被销毁。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> name: <span class="type">String</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(<span class="params">name</span>: <span class="type">String</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.name <span class="operator">=</span> name</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">deinit</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;<span class="subst">\(name)</span> 被销毁&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个Person实例，强引用计数为1</span></span><br><span class="line"><span class="keyword">var</span> strongReference: <span class="type">Person</span>? <span class="operator">=</span> <span class="type">Person</span>(name: <span class="string">&quot;李四&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 释放强引用，引用计数为0，实例被销毁</span></span><br><span class="line">strongReference <span class="operator">=</span> <span class="literal">nil</span></span><br></pre></td></tr></table></figure>

<h3 id="2-弱引用"><a href="#2-弱引用" class="headerlink" title="2. 弱引用"></a>2. 弱引用</h3><p>弱引用不会增加对象的引用计数，它用于解决循环引用问题。弱引用必须是可选类型，因为当对象被销毁时，弱引用会自动变为nil。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> name: <span class="type">String</span></span><br><span class="line">    <span class="keyword">var</span> apartment: <span class="type">Apartment</span>?</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(<span class="params">name</span>: <span class="type">String</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.name <span class="operator">=</span> name</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">deinit</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;<span class="subst">\(name)</span> 被销毁&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Apartment</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> unit: <span class="type">String</span></span><br><span class="line">    <span class="keyword">weak</span> <span class="keyword">var</span> tenant: <span class="type">Person</span>? <span class="comment">// 弱引用</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(<span class="params">unit</span>: <span class="type">String</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.unit <span class="operator">=</span> unit</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">deinit</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;公寓 <span class="subst">\(unit)</span> 被销毁&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建实例</span></span><br><span class="line"><span class="keyword">var</span> john: <span class="type">Person</span>? <span class="operator">=</span> <span class="type">Person</span>(name: <span class="string">&quot;John&quot;</span>)</span><br><span class="line"><span class="keyword">var</span> unit4A: <span class="type">Apartment</span>? <span class="operator">=</span> <span class="type">Apartment</span>(unit: <span class="string">&quot;4A&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 建立引用关系</span></span><br><span class="line">john<span class="operator">?</span>.apartment <span class="operator">=</span> unit4A</span><br><span class="line">unit4A<span class="operator">?</span>.tenant <span class="operator">=</span> john</span><br><span class="line"></span><br><span class="line"><span class="comment">// 释放强引用</span></span><br><span class="line">john <span class="operator">=</span> <span class="literal">nil</span></span><br><span class="line"><span class="comment">// 输出：John 被销毁</span></span><br><span class="line"></span><br><span class="line">unit4A <span class="operator">=</span> <span class="literal">nil</span></span><br><span class="line"><span class="comment">// 输出：公寓 4A 被销毁</span></span><br></pre></td></tr></table></figure>

<h3 id="3-无主引用"><a href="#3-无主引用" class="headerlink" title="3. 无主引用"></a>3. 无主引用</h3><p>无主引用不会增加对象的引用计数，它也用于解决循环引用问题。与弱引用不同的是，无主引用是非可选类型，它假设引用的对象始终存在。当对象被销毁时，无主引用不会自动变为nil，而是成为一个悬垂引用（Dangling Reference）。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> name: <span class="type">String</span></span><br><span class="line">    <span class="keyword">var</span> creditCard: <span class="type">CreditCard</span>?</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(<span class="params">name</span>: <span class="type">String</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.name <span class="operator">=</span> name</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">deinit</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;<span class="subst">\(name)</span> 被销毁&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CreditCard</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> number: <span class="type">UInt64</span></span><br><span class="line">    <span class="keyword">unowned</span> <span class="keyword">let</span> owner: <span class="type">Person</span> <span class="comment">// 无主引用</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(<span class="params">number</span>: <span class="type">UInt64</span>, <span class="params">owner</span>: <span class="type">Person</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.number <span class="operator">=</span> number</span><br><span class="line">        <span class="keyword">self</span>.owner <span class="operator">=</span> owner</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">deinit</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;信用卡 <span class="subst">\(number)</span> 被销毁&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建实例</span></span><br><span class="line"><span class="keyword">var</span> jack: <span class="type">Person</span>? <span class="operator">=</span> <span class="type">Person</span>(name: <span class="string">&quot;Jack&quot;</span>)</span><br><span class="line">jack<span class="operator">?</span>.creditCard <span class="operator">=</span> <span class="type">CreditCard</span>(number: <span class="number">1234_5678_9012_3456</span>, owner: jack<span class="operator">!</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 释放强引用</span></span><br><span class="line">jack <span class="operator">=</span> <span class="literal">nil</span></span><br><span class="line"><span class="comment">// 输出：Jack 被销毁</span></span><br><span class="line"><span class="comment">// 输出：信用卡 1234567890123456 被销毁</span></span><br></pre></td></tr></table></figure>

<!-- INTERVIEW_TOPIC: 循环引用 -->
<!-- HIGH_FREQUENCY_INTERVIEW: 循环引用的解决方法 -->

<h2 id="五、循环引用"><a href="#五、循环引用" class="headerlink" title="五、循环引用"></a>五、循环引用</h2><p>循环引用是指两个或多个对象之间相互引用，导致它们的引用计数永远不会变为0，从而造成内存泄漏。在Swift中，循环引用主要发生在以下两种情况：</p>
<h3 id="1-类实例之间的循环引用"><a href="#1-类实例之间的循环引用" class="headerlink" title="1. 类实例之间的循环引用"></a>1. 类实例之间的循环引用</h3><p>当两个类实例相互持有对方的强引用时，会发生循环引用：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> name: <span class="type">String</span></span><br><span class="line">    <span class="keyword">var</span> apartment: <span class="type">Apartment</span>?</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(<span class="params">name</span>: <span class="type">String</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.name <span class="operator">=</span> name</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">deinit</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;<span class="subst">\(name)</span> 被销毁&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Apartment</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> unit: <span class="type">String</span></span><br><span class="line">    <span class="keyword">var</span> tenant: <span class="type">Person</span>? <span class="comment">// 强引用</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(<span class="params">unit</span>: <span class="type">String</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.unit <span class="operator">=</span> unit</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">deinit</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;公寓 <span class="subst">\(unit)</span> 被销毁&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建实例，建立循环引用</span></span><br><span class="line"><span class="keyword">var</span> john: <span class="type">Person</span>? <span class="operator">=</span> <span class="type">Person</span>(name: <span class="string">&quot;John&quot;</span>)</span><br><span class="line"><span class="keyword">var</span> unit4A: <span class="type">Apartment</span>? <span class="operator">=</span> <span class="type">Apartment</span>(unit: <span class="string">&quot;4A&quot;</span>)</span><br><span class="line">john<span class="operator">?</span>.apartment <span class="operator">=</span> unit4A</span><br><span class="line">unit4A<span class="operator">?</span>.tenant <span class="operator">=</span> john</span><br><span class="line"></span><br><span class="line"><span class="comment">// 释放强引用，但由于循环引用，实例不会被销毁</span></span><br><span class="line">john <span class="operator">=</span> <span class="literal">nil</span></span><br><span class="line">unit4A <span class="operator">=</span> <span class="literal">nil</span></span><br><span class="line"><span class="comment">// 没有输出，说明实例没有被销毁，发生了内存泄漏</span></span><br></pre></td></tr></table></figure>

<p>解决类实例之间的循环引用的方法是使用弱引用或无主引用：</p>
<ul>
<li>当引用的对象可能为nil时，使用弱引用</li>
<li>当引用的对象永远不会为nil时，使用无主引用</li>
</ul>
<h3 id="2-闭包与类实例之间的循环引用"><a href="#2-闭包与类实例之间的循环引用" class="headerlink" title="2. 闭包与类实例之间的循环引用"></a>2. 闭包与类实例之间的循环引用</h3><p>当一个类实例持有一个闭包，而该闭包又捕获了该类实例的引用时，会发生循环引用：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> name: <span class="type">String</span></span><br><span class="line">    <span class="keyword">var</span> closure: (() -&gt; <span class="type">Void</span>)<span class="operator">?</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(<span class="params">name</span>: <span class="type">String</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.name <span class="operator">=</span> name</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">deinit</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;<span class="subst">\(name)</span> 被销毁&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建实例，建立循环引用</span></span><br><span class="line"><span class="keyword">var</span> tom: <span class="type">Person</span>? <span class="operator">=</span> <span class="type">Person</span>(name: <span class="string">&quot;Tom&quot;</span>)</span><br><span class="line">tom<span class="operator">?</span>.closure <span class="operator">=</span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Hello, <span class="subst">\(tom<span class="operator">?</span>.name)</span>!&quot;</span>) <span class="comment">// 闭包捕获了tom的强引用</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 释放强引用，但由于循环引用，实例不会被销毁</span></span><br><span class="line">tom <span class="operator">=</span> <span class="literal">nil</span></span><br><span class="line"><span class="comment">// 没有输出，说明实例没有被销毁，发生了内存泄漏</span></span><br></pre></td></tr></table></figure>

<p>解决闭包与类实例之间的循环引用的方法是使用捕获列表（Capture List）：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> name: <span class="type">String</span></span><br><span class="line">    <span class="keyword">var</span> closure: (() -&gt; <span class="type">Void</span>)<span class="operator">?</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(<span class="params">name</span>: <span class="type">String</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.name <span class="operator">=</span> name</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">deinit</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;<span class="subst">\(name)</span> 被销毁&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建实例，使用捕获列表避免循环引用</span></span><br><span class="line"><span class="keyword">var</span> tom: <span class="type">Person</span>? <span class="operator">=</span> <span class="type">Person</span>(name: <span class="string">&quot;Tom&quot;</span>)</span><br><span class="line">tom<span class="operator">?</span>.closure <span class="operator">=</span> &#123;</span><br><span class="line">    [<span class="keyword">weak</span> tom] <span class="keyword">in</span> <span class="comment">// 使用捕获列表，将tom声明为弱引用</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Hello, <span class="subst">\(tom<span class="operator">?</span>.name)</span>!&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 释放强引用，实例会被销毁</span></span><br><span class="line">tom <span class="operator">=</span> <span class="literal">nil</span></span><br><span class="line"><span class="comment">// 输出：Tom 被销毁</span></span><br></pre></td></tr></table></figure>

<h3 id="3-捕获列表的语法"><a href="#3-捕获列表的语法" class="headerlink" title="3. 捕获列表的语法"></a>3. 捕获列表的语法</h3><p>捕获列表用于在闭包中指定捕获变量的引用类型，语法如下：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="keyword">weak</span> <span class="keyword">self</span>, <span class="keyword">unowned</span> delegate <span class="operator">=</span> <span class="keyword">self</span>.delegate]</span><br></pre></td></tr></table></figure>

<p>捕获列表中的每个元素可以是：</p>
<ul>
<li><code>weak varName</code>：将变量声明为弱引用</li>
<li><code>unowned varName</code>：将变量声明为无主引用</li>
<li><code>varName = expression</code>：将表达式的值绑定到变量</li>
</ul>
<h3 id="4-闭包中的self"><a href="#4-闭包中的self" class="headerlink" title="4. 闭包中的self"></a>4. 闭包中的self</h3><p>在闭包中，如果需要访问self的属性或方法，通常需要显式地使用self关键字。如果闭包捕获了self的强引用，会导致循环引用。解决方法是在捕获列表中使用weak或unowned关键字声明self：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> name: <span class="type">String</span></span><br><span class="line">    <span class="keyword">var</span> age: <span class="type">Int</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(<span class="params">name</span>: <span class="type">String</span>, <span class="params">age</span>: <span class="type">Int</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.name <span class="operator">=</span> name</span><br><span class="line">        <span class="keyword">self</span>.age <span class="operator">=</span> age</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">lazy</span> <span class="keyword">var</span> description: () -&gt; <span class="type">String</span> <span class="operator">=</span> &#123;</span><br><span class="line">        [<span class="keyword">unowned</span> <span class="keyword">self</span>] <span class="keyword">in</span> <span class="comment">// 使用捕获列表，将self声明为无主引用</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;<span class="subst">\(<span class="keyword">self</span>.name)</span> 今年 <span class="subst">\(<span class="keyword">self</span>.age)</span> 岁&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">deinit</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;<span class="subst">\(name)</span> 被销毁&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建实例</span></span><br><span class="line"><span class="keyword">var</span> alice: <span class="type">Person</span>? <span class="operator">=</span> <span class="type">Person</span>(name: <span class="string">&quot;Alice&quot;</span>, age: <span class="number">25</span>)</span><br><span class="line"><span class="built_in">print</span>(alice<span class="operator">?</span>.description() <span class="operator">??</span> <span class="string">&quot;&quot;</span>) <span class="comment">// 输出：Alice 今年 25 岁</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 释放强引用，实例会被销毁</span></span><br><span class="line">alice <span class="operator">=</span> <span class="literal">nil</span></span><br><span class="line"><span class="comment">// 输出：Alice 被销毁</span></span><br></pre></td></tr></table></figure>

<h2 id="六、内存管理的最佳实践"><a href="#六、内存管理的最佳实践" class="headerlink" title="六、内存管理的最佳实践"></a>六、内存管理的最佳实践</h2><h3 id="1-优先使用值类型"><a href="#1-优先使用值类型" class="headerlink" title="1. 优先使用值类型"></a>1. 优先使用值类型</h3><p>值类型存储在栈内存中，由系统自动管理，不会造成内存泄漏。因此，在可能的情况下，应该优先使用值类型（如结构体和枚举）而不是引用类型（如类）。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用结构体（值类型）</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Point</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> x: <span class="type">Int</span></span><br><span class="line">    <span class="keyword">var</span> y: <span class="type">Int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用枚举（值类型）</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Direction</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> north, south, east, west</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 只有在需要继承或引用语义时，才使用类（引用类型）</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Vehicle</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> speed: <span class="type">Int</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(<span class="params">speed</span>: <span class="type">Int</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.speed <span class="operator">=</span> speed</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">accelerate</span>() &#123;</span><br><span class="line">        speed <span class="operator">+=</span> <span class="number">10</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-避免不必要的强引用"><a href="#2-避免不必要的强引用" class="headerlink" title="2. 避免不必要的强引用"></a>2. 避免不必要的强引用</h3><p>在使用引用类型时，应该避免不必要的强引用，特别是在闭包和委托模式中。</p>
<h4 id="委托模式中的弱引用"><a href="#委托模式中的弱引用" class="headerlink" title="委托模式中的弱引用"></a>委托模式中的弱引用</h4><p>在委托模式中，通常应该将委托声明为弱引用：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义委托协议</span></span><br><span class="line"><span class="keyword">protocol</span> <span class="title class_">UserInputDelegate</span>: <span class="title class_ inherited__">AnyObject</span> &#123;</span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">userDidInputText</span>(<span class="keyword">_</span> <span class="params">text</span>: <span class="type">String</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个类，使用委托</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserInputView</span> &#123;</span><br><span class="line">    <span class="keyword">weak</span> <span class="keyword">var</span> delegate: <span class="type">UserInputDelegate</span>? <span class="comment">// 弱引用委托</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">textFieldDidChange</span>(<span class="keyword">_</span> <span class="params">text</span>: <span class="type">String</span>) &#123;</span><br><span class="line">        delegate<span class="operator">?</span>.userDidInputText(text)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 遵循委托协议</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ViewController</span>: <span class="title class_ inherited__">UserInputDelegate</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> inputView <span class="operator">=</span> <span class="type">UserInputView</span>()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>() &#123;</span><br><span class="line">        inputView.delegate <span class="operator">=</span> <span class="keyword">self</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">userDidInputText</span>(<span class="keyword">_</span> <span class="params">text</span>: <span class="type">String</span>) &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;用户输入了：<span class="subst">\(text)</span>&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">deinit</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;ViewController 被销毁&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：在协议中使用<code>AnyObject</code>关键字可以确保协议只能被类遵循，这是使用弱引用委托的前提条件。</p>
<h3 id="3-及时清理资源"><a href="#3-及时清理资源" class="headerlink" title="3. 及时清理资源"></a>3. 及时清理资源</h3><p>在对象被销毁前，应该及时清理资源，例如：</p>
<ul>
<li>取消网络请求</li>
<li>停止定时器</li>
<li>移除通知观察者</li>
<li>释放其他系统资源</li>
</ul>
<p>这些清理工作通常在<code>deinit</code>方法中完成：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">NetworkManager</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> session: <span class="type">URLSession</span>?</span><br><span class="line">    <span class="keyword">var</span> task: <span class="type">URLSessionDataTask</span>?</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>() &#123;</span><br><span class="line">        session <span class="operator">=</span> <span class="type">URLSession</span>(configuration: .default)</span><br><span class="line">        <span class="comment">// 注册通知观察者</span></span><br><span class="line">        <span class="type">NotificationCenter</span>.default.addObserver(</span><br><span class="line">            <span class="keyword">self</span>,</span><br><span class="line">            selector: <span class="keyword">#selector</span>(handleNotification),</span><br><span class="line">            name: <span class="type">NSNotification</span>.<span class="type">Name</span>(<span class="string">&quot;SomeNotification&quot;</span>),</span><br><span class="line">            object: <span class="literal">nil</span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">fetchData</span>(<span class="params">from</span> <span class="params">url</span>: <span class="type">URL</span>) &#123;</span><br><span class="line">        task <span class="operator">=</span> session<span class="operator">?</span>.dataTask(with: url) &#123; data, response, error <span class="keyword">in</span></span><br><span class="line">            <span class="comment">// 处理响应</span></span><br><span class="line">        &#125;</span><br><span class="line">        task<span class="operator">?</span>.resume()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">@objc</span> <span class="keyword">func</span> <span class="title function_">handleNotification</span>() &#123;</span><br><span class="line">        <span class="comment">// 处理通知</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">deinit</span> &#123;</span><br><span class="line">        <span class="comment">// 取消网络请求</span></span><br><span class="line">        task<span class="operator">?</span>.cancel()</span><br><span class="line">        session<span class="operator">?</span>.invalidateAndCancel()</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 移除通知观察者</span></span><br><span class="line">        <span class="type">NotificationCenter</span>.default.removeObserver(<span class="keyword">self</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;NetworkManager 被销毁&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-使用内存分析工具"><a href="#4-使用内存分析工具" class="headerlink" title="4. 使用内存分析工具"></a>4. 使用内存分析工具</h3><p>在开发过程中，可以使用Xcode的内存分析工具（如Leaks、Allocations等）来检测内存泄漏：</p>
<ul>
<li><strong>Leaks</strong>：用于检测内存泄漏</li>
<li><strong>Allocations</strong>：用于分析内存分配情况</li>
<li><strong>Instruments</strong>：提供更全面的性能分析工具</li>
</ul>
<h3 id="5-避免保留周期"><a href="#5-避免保留周期" class="headerlink" title="5. 避免保留周期"></a>5. 避免保留周期</h3><p>保留周期（Retain Cycle）是指两个或多个对象之间的循环引用，导致它们的引用计数永远不会变为0。在Swift中，保留周期主要发生在类实例之间的循环引用和闭包与类实例之间的循环引用。解决保留周期的方法是使用弱引用或无主引用。</p>
<h2 id="七、内存管理的高级话题"><a href="#七、内存管理的高级话题" class="headerlink" title="七、内存管理的高级话题"></a>七、内存管理的高级话题</h2><h3 id="1-自动释放池"><a href="#1-自动释放池" class="headerlink" title="1. 自动释放池"></a>1. 自动释放池</h3><p>自动释放池（Autorelease Pool）是Cocoa Touch框架中的一个概念，它用于管理临时对象的内存。在Swift中，我们可以使用<code>autoreleasepool</code>函数来创建自动释放池：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">autoreleasepool &#123;</span><br><span class="line">    <span class="comment">// 在自动释放池中创建临时对象</span></span><br><span class="line">    <span class="keyword">let</span> image <span class="operator">=</span> <span class="type">UIImage</span>(named: <span class="string">&quot;large-image.jpg&quot;</span>)</span><br><span class="line">    <span class="keyword">let</span> view <span class="operator">=</span> <span class="type">UIImageView</span>(image: image)</span><br><span class="line">    <span class="comment">// 使用临时对象</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 自动释放池结束后，临时对象会被释放</span></span><br></pre></td></tr></table></figure>

<p>自动释放池适用于创建大量临时对象的场景，可以减少内存峰值。</p>
<h3 id="2-弱引用数组"><a href="#2-弱引用数组" class="headerlink" title="2. 弱引用数组"></a>2. 弱引用数组</h3><p>在某些情况下，我们需要维护一个对象的弱引用数组，以便在对象被销毁时自动从数组中移除。我们可以使用<code>NSPointerArray</code>或自定义的弱引用包装器来实现：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义一个弱引用包装器</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Weak</span>&lt;<span class="type">T</span>: <span class="type">AnyObject</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">weak</span> <span class="keyword">var</span> value: <span class="type">T</span>?</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(<span class="params">value</span>: <span class="type">T</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.value <span class="operator">=</span> value</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个弱引用数组</span></span><br><span class="line"><span class="keyword">var</span> observers: [<span class="type">Weak</span>&lt;<span class="type">NSObject</span>&gt;] <span class="operator">=</span> []</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加观察者</span></span><br><span class="line"><span class="keyword">let</span> observer <span class="operator">=</span> <span class="type">NSObject</span>()</span><br><span class="line">observers.append(<span class="type">Weak</span>(value: observer))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 移除已销毁的观察者</span></span><br><span class="line">observers <span class="operator">=</span> observers.filter &#123; <span class="variable">$0</span>.value <span class="operator">!=</span> <span class="literal">nil</span> &#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-延迟初始化"><a href="#3-延迟初始化" class="headerlink" title="3. 延迟初始化"></a>3. 延迟初始化</h3><p>延迟初始化是指在首次访问属性时才初始化属性值，这可以减少对象的初始化时间和内存占用。在Swift中，我们可以使用<code>lazy</code>关键字来实现延迟初始化：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DataManager</span> &#123;</span><br><span class="line">    <span class="keyword">lazy</span> <span class="keyword">var</span> database: <span class="type">Database</span> <span class="operator">=</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> db <span class="operator">=</span> <span class="type">Database</span>()</span><br><span class="line">        db.connect()</span><br><span class="line">        <span class="keyword">return</span> db</span><br><span class="line">    &#125;()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">deinit</span> &#123;</span><br><span class="line">        database.disconnect()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：延迟初始化的属性必须是变量（var），不能是常量（let）。</p>
<h2 id="八、内容机制与知识点总结"><a href="#八、内容机制与知识点总结" class="headerlink" title="八、内容机制与知识点总结"></a>八、内容机制与知识点总结</h2><h3 id="1-Swift内存管理的设计原则"><a href="#1-Swift内存管理的设计原则" class="headerlink" title="1. Swift内存管理的设计原则"></a>1. Swift内存管理的设计原则</h3><p>Swift的内存管理机制体现了几个核心设计原则：</p>
<ul>
<li><strong>自动管理优先</strong>：默认使用自动引用计数（ARC），减少手动内存管理的负担</li>
<li><strong>安全第一</strong>：通过引用类型（强、弱、无主）的明确区分，减少内存泄漏</li>
<li><strong>性能优化</strong>：值类型存储在栈上，引用类型存储在堆上，平衡性能和灵活性</li>
<li><strong>类型安全</strong>：通过类型系统确保内存操作的安全性</li>
<li><strong>透明度</strong>：内存管理机制清晰可预测，便于开发者理解和调试</li>
</ul>
<h3 id="2-核心知识点总结"><a href="#2-核心知识点总结" class="headerlink" title="2. 核心知识点总结"></a>2. 核心知识点总结</h3><table>
<thead>
<tr>
<th>概念</th>
<th>描述</th>
<th>主要特性</th>
</tr>
</thead>
<tbody><tr>
<td>堆内存</td>
<td>用于存储对象实例和较大数据结构</td>
<td>动态分配，由ARC管理</td>
</tr>
<tr>
<td>栈内存</td>
<td>用于存储临时变量和函数调用信息</td>
<td>自动分配释放，速度快</td>
</tr>
<tr>
<td>值类型</td>
<td>包括结构体、枚举和基本数据类型</td>
<td>赋值时值拷贝，无引用计数</td>
</tr>
<tr>
<td>引用类型</td>
<td>包括类和闭包</td>
<td>赋值时引用拷贝，有引用计数</td>
</tr>
<tr>
<td>自动引用计数（ARC）</td>
<td>自动跟踪和管理对象引用计数</td>
<td>引用计数为0时释放内存</td>
</tr>
<tr>
<td>强引用</td>
<td>默认引用类型，增加引用计数</td>
<td>可能导致循环引用</td>
</tr>
<tr>
<td>弱引用</td>
<td>不增加引用计数，对象销毁时变为nil</td>
<td>解决循环引用，可选类型</td>
</tr>
<tr>
<td>无主引用</td>
<td>不增加引用计数，对象销毁时不变为nil</td>
<td>解决循环引用，非可选类型</td>
</tr>
<tr>
<td>循环引用</td>
<td>两个或多个对象相互引用，导致内存泄漏</td>
<td>需使用弱引用或无主引用解决</td>
</tr>
<tr>
<td>闭包捕获列表</td>
<td>指定闭包中变量的引用类型</td>
<td>避免闭包与实例的循环引用</td>
</tr>
<tr>
<td><code>deinit</code>方法</td>
<td>对象被销毁前调用的方法</td>
<td>用于资源清理</td>
</tr>
</tbody></table>
<h2 id="九、遇到的问题及解决方案"><a href="#九、遇到的问题及解决方案" class="headerlink" title="九、遇到的问题及解决方案"></a>九、遇到的问题及解决方案</h2><h3 id="1-循环引用导致内存泄漏"><a href="#1-循环引用导致内存泄漏" class="headerlink" title="1. 循环引用导致内存泄漏"></a>1. 循环引用导致内存泄漏</h3><p><strong>问题</strong>：两个类实例相互持有强引用，导致引用计数永远不为0，内存无法释放</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> name: <span class="type">String</span></span><br><span class="line">    <span class="keyword">var</span> apartment: <span class="type">Apartment</span>? <span class="comment">// 强引用</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(<span class="params">name</span>: <span class="type">String</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.name <span class="operator">=</span> name</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">deinit</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;<span class="subst">\(name)</span> 被销毁&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Apartment</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> unit: <span class="type">String</span></span><br><span class="line">    <span class="keyword">var</span> tenant: <span class="type">Person</span>? <span class="comment">// 强引用</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(<span class="params">unit</span>: <span class="type">String</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.unit <span class="operator">=</span> unit</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">deinit</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;公寓 <span class="subst">\(unit)</span> 被销毁&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建实例，建立循环引用</span></span><br><span class="line"><span class="keyword">var</span> john: <span class="type">Person</span>? <span class="operator">=</span> <span class="type">Person</span>(name: <span class="string">&quot;John&quot;</span>)</span><br><span class="line"><span class="keyword">var</span> unit4A: <span class="type">Apartment</span>? <span class="operator">=</span> <span class="type">Apartment</span>(unit: <span class="string">&quot;4A&quot;</span>)</span><br><span class="line">john<span class="operator">?</span>.apartment <span class="operator">=</span> unit4A</span><br><span class="line">unit4A<span class="operator">?</span>.tenant <span class="operator">=</span> john</span><br><span class="line"></span><br><span class="line"><span class="comment">// 释放强引用，但由于循环引用，实例不会被销毁</span></span><br><span class="line">john <span class="operator">=</span> <span class="literal">nil</span></span><br><span class="line">unit4A <span class="operator">=</span> <span class="literal">nil</span></span><br><span class="line"><span class="comment">// 没有输出，发生内存泄漏</span></span><br></pre></td></tr></table></figure>

<p><strong>解决方案</strong>：使用弱引用或无主引用打破循环引用</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> name: <span class="type">String</span></span><br><span class="line">    <span class="keyword">var</span> apartment: <span class="type">Apartment</span>? <span class="comment">// 强引用</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(<span class="params">name</span>: <span class="type">String</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.name <span class="operator">=</span> name</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">deinit</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;<span class="subst">\(name)</span> 被销毁&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Apartment</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> unit: <span class="type">String</span></span><br><span class="line">    <span class="keyword">weak</span> <span class="keyword">var</span> tenant: <span class="type">Person</span>? <span class="comment">// 弱引用</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(<span class="params">unit</span>: <span class="type">String</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.unit <span class="operator">=</span> unit</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">deinit</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;公寓 <span class="subst">\(unit)</span> 被销毁&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建实例，建立引用关系</span></span><br><span class="line"><span class="keyword">var</span> john: <span class="type">Person</span>? <span class="operator">=</span> <span class="type">Person</span>(name: <span class="string">&quot;John&quot;</span>)</span><br><span class="line"><span class="keyword">var</span> unit4A: <span class="type">Apartment</span>? <span class="operator">=</span> <span class="type">Apartment</span>(unit: <span class="string">&quot;4A&quot;</span>)</span><br><span class="line">john<span class="operator">?</span>.apartment <span class="operator">=</span> unit4A</span><br><span class="line">unit4A<span class="operator">?</span>.tenant <span class="operator">=</span> john</span><br><span class="line"></span><br><span class="line"><span class="comment">// 释放强引用，实例会被销毁</span></span><br><span class="line">john <span class="operator">=</span> <span class="literal">nil</span></span><br><span class="line"><span class="comment">// 输出：John 被销毁</span></span><br><span class="line"></span><br><span class="line">unit4A <span class="operator">=</span> <span class="literal">nil</span></span><br><span class="line"><span class="comment">// 输出：公寓 4A 被销毁</span></span><br></pre></td></tr></table></figure>

<h3 id="2-闭包与实例的循环引用"><a href="#2-闭包与实例的循环引用" class="headerlink" title="2. 闭包与实例的循环引用"></a>2. 闭包与实例的循环引用</h3><p><strong>问题</strong>：闭包捕获了实例的强引用，导致循环引用</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> name: <span class="type">String</span></span><br><span class="line">    <span class="keyword">var</span> closure: (() -&gt; <span class="type">Void</span>)<span class="operator">?</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(<span class="params">name</span>: <span class="type">String</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.name <span class="operator">=</span> name</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">deinit</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;<span class="subst">\(name)</span> 被销毁&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建实例，建立循环引用</span></span><br><span class="line"><span class="keyword">var</span> tom: <span class="type">Person</span>? <span class="operator">=</span> <span class="type">Person</span>(name: <span class="string">&quot;Tom&quot;</span>)</span><br><span class="line">tom<span class="operator">?</span>.closure <span class="operator">=</span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Hello, <span class="subst">\(tom<span class="operator">?</span>.name)</span>!&quot;</span>) <span class="comment">// 闭包捕获了tom的强引用</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 释放强引用，但由于循环引用，实例不会被销毁</span></span><br><span class="line">tom <span class="operator">=</span> <span class="literal">nil</span></span><br><span class="line"><span class="comment">// 没有输出，发生内存泄漏</span></span><br></pre></td></tr></table></figure>

<p><strong>解决方案</strong>：使用捕获列表避免循环引用</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> name: <span class="type">String</span></span><br><span class="line">    <span class="keyword">var</span> closure: (() -&gt; <span class="type">Void</span>)<span class="operator">?</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(<span class="params">name</span>: <span class="type">String</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.name <span class="operator">=</span> name</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">deinit</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;<span class="subst">\(name)</span> 被销毁&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建实例，使用捕获列表避免循环引用</span></span><br><span class="line"><span class="keyword">var</span> tom: <span class="type">Person</span>? <span class="operator">=</span> <span class="type">Person</span>(name: <span class="string">&quot;Tom&quot;</span>)</span><br><span class="line">tom<span class="operator">?</span>.closure <span class="operator">=</span> &#123;</span><br><span class="line">    [<span class="keyword">weak</span> tom] <span class="keyword">in</span> <span class="comment">// 使用捕获列表，将tom声明为弱引用</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Hello, <span class="subst">\(tom<span class="operator">?</span>.name)</span>!&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 释放强引用，实例会被销毁</span></span><br><span class="line">tom <span class="operator">=</span> <span class="literal">nil</span></span><br><span class="line"><span class="comment">// 输出：Tom 被销毁</span></span><br></pre></td></tr></table></figure>

<h3 id="3-委托模式中的循环引用"><a href="#3-委托模式中的循环引用" class="headerlink" title="3. 委托模式中的循环引用"></a>3. 委托模式中的循环引用</h3><p><strong>问题</strong>：委托对象和被委托对象之间的循环引用</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protocol</span> <span class="title class_">UserInputDelegate</span> &#123;</span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">userDidInputText</span>(<span class="keyword">_</span> <span class="params">text</span>: <span class="type">String</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserInputView</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> delegate: <span class="type">UserInputDelegate</span>? <span class="comment">// 强引用委托</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">textFieldDidChange</span>(<span class="keyword">_</span> <span class="params">text</span>: <span class="type">String</span>) &#123;</span><br><span class="line">        delegate<span class="operator">?</span>.userDidInputText(text)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">deinit</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;UserInputView 被销毁&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ViewController</span>: <span class="title class_ inherited__">UserInputDelegate</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> inputView <span class="operator">=</span> <span class="type">UserInputView</span>()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>() &#123;</span><br><span class="line">        inputView.delegate <span class="operator">=</span> <span class="keyword">self</span> <span class="comment">// 强引用循环</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">userDidInputText</span>(<span class="keyword">_</span> <span class="params">text</span>: <span class="type">String</span>) &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;用户输入了：<span class="subst">\(text)</span>&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">deinit</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;ViewController 被销毁&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建实例，建立循环引用</span></span><br><span class="line"><span class="keyword">var</span> vc: <span class="type">ViewController</span>? <span class="operator">=</span> <span class="type">ViewController</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 释放强引用，但由于循环引用，实例不会被销毁</span></span><br><span class="line">vc <span class="operator">=</span> <span class="literal">nil</span></span><br><span class="line"><span class="comment">// 没有输出，发生内存泄漏</span></span><br></pre></td></tr></table></figure>

<p><strong>解决方案</strong>：将委托声明为弱引用</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protocol</span> <span class="title class_">UserInputDelegate</span>: <span class="title class_ inherited__">AnyObject</span> &#123; <span class="comment">// 确保协议只能被类遵循</span></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">userDidInputText</span>(<span class="keyword">_</span> <span class="params">text</span>: <span class="type">String</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserInputView</span> &#123;</span><br><span class="line">    <span class="keyword">weak</span> <span class="keyword">var</span> delegate: <span class="type">UserInputDelegate</span>? <span class="comment">// 弱引用委托</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">textFieldDidChange</span>(<span class="keyword">_</span> <span class="params">text</span>: <span class="type">String</span>) &#123;</span><br><span class="line">        delegate<span class="operator">?</span>.userDidInputText(text)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">deinit</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;UserInputView 被销毁&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ViewController</span>: <span class="title class_ inherited__">UserInputDelegate</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> inputView <span class="operator">=</span> <span class="type">UserInputView</span>()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>() &#123;</span><br><span class="line">        inputView.delegate <span class="operator">=</span> <span class="keyword">self</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">userDidInputText</span>(<span class="keyword">_</span> <span class="params">text</span>: <span class="type">String</span>) &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;用户输入了：<span class="subst">\(text)</span>&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">deinit</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;ViewController 被销毁&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建实例</span></span><br><span class="line"><span class="keyword">var</span> vc: <span class="type">ViewController</span>? <span class="operator">=</span> <span class="type">ViewController</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 释放强引用，实例会被销毁</span></span><br><span class="line">vc <span class="operator">=</span> <span class="literal">nil</span></span><br><span class="line"><span class="comment">// 输出：ViewController 被销毁</span></span><br><span class="line"><span class="comment">// 输出：UserInputView 被销毁</span></span><br></pre></td></tr></table></figure>

<h3 id="4-强引用循环在延迟属性中"><a href="#4-强引用循环在延迟属性中" class="headerlink" title="4. 强引用循环在延迟属性中"></a>4. 强引用循环在延迟属性中</h3><p><strong>问题</strong>：延迟属性中的闭包与实例形成循环引用</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> name: <span class="type">String</span></span><br><span class="line">    <span class="keyword">var</span> age: <span class="type">Int</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(<span class="params">name</span>: <span class="type">String</span>, <span class="params">age</span>: <span class="type">Int</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.name <span class="operator">=</span> name</span><br><span class="line">        <span class="keyword">self</span>.age <span class="operator">=</span> age</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">lazy</span> <span class="keyword">var</span> description: () -&gt; <span class="type">String</span> <span class="operator">=</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;<span class="subst">\(<span class="keyword">self</span>.name)</span> 今年 <span class="subst">\(<span class="keyword">self</span>.age)</span> 岁&quot;</span> <span class="comment">// 闭包捕获了self的强引用</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">deinit</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;<span class="subst">\(name)</span> 被销毁&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建实例，建立循环引用</span></span><br><span class="line"><span class="keyword">var</span> alice: <span class="type">Person</span>? <span class="operator">=</span> <span class="type">Person</span>(name: <span class="string">&quot;Alice&quot;</span>, age: <span class="number">25</span>)</span><br><span class="line"><span class="built_in">print</span>(alice<span class="operator">?</span>.description() <span class="operator">??</span> <span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 释放强引用，但由于循环引用，实例不会被销毁</span></span><br><span class="line">alice <span class="operator">=</span> <span class="literal">nil</span></span><br><span class="line"><span class="comment">// 没有输出，发生内存泄漏</span></span><br></pre></td></tr></table></figure>

<p><strong>解决方案</strong>：在延迟属性的闭包中使用捕获列表</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> name: <span class="type">String</span></span><br><span class="line">    <span class="keyword">var</span> age: <span class="type">Int</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(<span class="params">name</span>: <span class="type">String</span>, <span class="params">age</span>: <span class="type">Int</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.name <span class="operator">=</span> name</span><br><span class="line">        <span class="keyword">self</span>.age <span class="operator">=</span> age</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">lazy</span> <span class="keyword">var</span> description: () -&gt; <span class="type">String</span> <span class="operator">=</span> &#123;</span><br><span class="line">        [<span class="keyword">unowned</span> <span class="keyword">self</span>] <span class="keyword">in</span> <span class="comment">// 使用捕获列表，将self声明为无主引用</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;<span class="subst">\(<span class="keyword">self</span>.name)</span> 今年 <span class="subst">\(<span class="keyword">self</span>.age)</span> 岁&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">deinit</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;<span class="subst">\(name)</span> 被销毁&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建实例</span></span><br><span class="line"><span class="keyword">var</span> alice: <span class="type">Person</span>? <span class="operator">=</span> <span class="type">Person</span>(name: <span class="string">&quot;Alice&quot;</span>, age: <span class="number">25</span>)</span><br><span class="line"><span class="built_in">print</span>(alice<span class="operator">?</span>.description() <span class="operator">??</span> <span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 释放强引用，实例会被销毁</span></span><br><span class="line">alice <span class="operator">=</span> <span class="literal">nil</span></span><br><span class="line"><span class="comment">// 输出：Alice 被销毁</span></span><br></pre></td></tr></table></figure>

<h3 id="5-不正确使用无主引用导致崩溃"><a href="#5-不正确使用无主引用导致崩溃" class="headerlink" title="5. 不正确使用无主引用导致崩溃"></a>5. 不正确使用无主引用导致崩溃</h3><p><strong>问题</strong>：使用无主引用引用已经被销毁的对象，导致运行时崩溃</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> name: <span class="type">String</span></span><br><span class="line">    <span class="keyword">var</span> creditCard: <span class="type">CreditCard</span>?</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(<span class="params">name</span>: <span class="type">String</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.name <span class="operator">=</span> name</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">deinit</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;<span class="subst">\(name)</span> 被销毁&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CreditCard</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> number: <span class="type">UInt64</span></span><br><span class="line">    <span class="keyword">unowned</span> <span class="keyword">let</span> owner: <span class="type">Person</span> <span class="comment">// 无主引用</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(<span class="params">number</span>: <span class="type">UInt64</span>, <span class="params">owner</span>: <span class="type">Person</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.number <span class="operator">=</span> number</span><br><span class="line">        <span class="keyword">self</span>.owner <span class="operator">=</span> owner</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">deinit</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;信用卡 <span class="subst">\(number)</span> 被销毁&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建实例</span></span><br><span class="line"><span class="keyword">var</span> jack: <span class="type">Person</span>? <span class="operator">=</span> <span class="type">Person</span>(name: <span class="string">&quot;Jack&quot;</span>)</span><br><span class="line"><span class="keyword">var</span> card: <span class="type">CreditCard</span>? <span class="operator">=</span> <span class="type">CreditCard</span>(number: <span class="number">1234_5678_9012_3456</span>, owner: jack<span class="operator">!</span>)</span><br><span class="line">jack<span class="operator">?</span>.creditCard <span class="operator">=</span> card</span><br><span class="line"></span><br><span class="line"><span class="comment">// 释放Person实例</span></span><br><span class="line">jack <span class="operator">=</span> <span class="literal">nil</span></span><br><span class="line"><span class="comment">// 输出：Jack 被销毁</span></span><br><span class="line"><span class="comment">// 输出：信用卡 1234567890123456 被销毁</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 访问已销毁对象的无主引用，导致崩溃</span></span><br><span class="line"><span class="built_in">print</span>(card<span class="operator">?</span>.owner.name <span class="operator">??</span> <span class="string">&quot;&quot;</span>) <span class="comment">// 崩溃！</span></span><br></pre></td></tr></table></figure>

<p><strong>解决方案</strong>：确保无主引用的对象在无主引用使用期间始终存在，或改用弱引用</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CreditCard</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> number: <span class="type">UInt64</span></span><br><span class="line">    <span class="keyword">weak</span> <span class="keyword">var</span> owner: <span class="type">Person</span>? <span class="comment">// 改用弱引用</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(<span class="params">number</span>: <span class="type">UInt64</span>, <span class="params">owner</span>: <span class="type">Person</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.number <span class="operator">=</span> number</span><br><span class="line">        <span class="keyword">self</span>.owner <span class="operator">=</span> owner</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">deinit</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;信用卡 <span class="subst">\(number)</span> 被销毁&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用弱引用访问</span></span><br><span class="line"><span class="built_in">print</span>(card<span class="operator">?</span>.owner<span class="operator">?</span>.name <span class="operator">??</span> <span class="string">&quot;所有者不存在&quot;</span>) <span class="comment">// 输出：所有者不存在</span></span><br></pre></td></tr></table></figure>

<h2 id="十、高阶用法"><a href="#十、高阶用法" class="headerlink" title="十、高阶用法"></a>十、高阶用法</h2><h3 id="1-高级内存管理技巧"><a href="#1-高级内存管理技巧" class="headerlink" title="1. 高级内存管理技巧"></a>1. 高级内存管理技巧</h3><h4 id="1-1-弱引用数组实现"><a href="#1-1-弱引用数组实现" class="headerlink" title="1.1 弱引用数组实现"></a>1.1 弱引用数组实现</h4><p>实现一个自动管理的弱引用数组，自动移除已销毁的对象：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 弱引用包装器</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Weak</span>&lt;<span class="type">T</span>: <span class="type">AnyObject</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">weak</span> <span class="keyword">var</span> value: <span class="type">T</span>?</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(<span class="params">value</span>: <span class="type">T</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.value <span class="operator">=</span> value</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 弱引用数组</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WeakArray</span>&lt;<span class="type">T</span>: <span class="type">AnyObject</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> items: [<span class="type">Weak</span>&lt;<span class="type">T</span>&gt;] <span class="operator">=</span> []</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 添加元素</span></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">append</span>(<span class="keyword">_</span> <span class="params">item</span>: <span class="type">T</span>) &#123;</span><br><span class="line">        items.append(<span class="type">Weak</span>(value: item))</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取所有有效的元素</span></span><br><span class="line">    <span class="keyword">var</span> validItems: [<span class="type">T</span>] &#123;</span><br><span class="line">        <span class="comment">// 过滤掉已销毁的对象，并清理数组</span></span><br><span class="line">        items <span class="operator">=</span> items.filter &#123; <span class="variable">$0</span>.value <span class="operator">!=</span> <span class="literal">nil</span> &#125;</span><br><span class="line">        <span class="keyword">return</span> items.compactMap &#123; <span class="variable">$0</span>.value &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 清空数组</span></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">removeAll</span>() &#123;</span><br><span class="line">        items.removeAll()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Observer</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> name: <span class="type">String</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(<span class="params">name</span>: <span class="type">String</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.name <span class="operator">=</span> name</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">deinit</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;<span class="subst">\(name)</span> 被销毁&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">update</span>() &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;<span class="subst">\(name)</span> 收到更新通知&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建弱引用数组</span></span><br><span class="line"><span class="keyword">let</span> observers <span class="operator">=</span> <span class="type">WeakArray</span>&lt;<span class="type">Observer</span>&gt;()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加观察者</span></span><br><span class="line"><span class="keyword">let</span> observer1 <span class="operator">=</span> <span class="type">Observer</span>(name: <span class="string">&quot;观察者1&quot;</span>)</span><br><span class="line"><span class="keyword">let</span> observer2 <span class="operator">=</span> <span class="type">Observer</span>(name: <span class="string">&quot;观察者2&quot;</span>)</span><br><span class="line">observers.append(observer1)</span><br><span class="line">observers.append(observer2)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通知所有观察者</span></span><br><span class="line"><span class="keyword">for</span> observer <span class="keyword">in</span> observers.validItems &#123;</span><br><span class="line">    observer.update()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 释放一个观察者</span></span><br><span class="line">observer1 <span class="operator">=</span> <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 通知所有有效观察者（自动移除已销毁的观察者）</span></span><br><span class="line"><span class="keyword">for</span> observer <span class="keyword">in</span> observers.validItems &#123;</span><br><span class="line">    observer.update()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1-2-弱引用字典实现"><a href="#1-2-弱引用字典实现" class="headerlink" title="1.2 弱引用字典实现"></a>1.2 弱引用字典实现</h4><p>实现一个弱引用字典，键是强引用，值是弱引用：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">WeakValueDictionary</span>&lt;<span class="type">Key</span>: <span class="type">Hashable</span>, <span class="type">Value</span>: <span class="type">AnyObject</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> dictionary: [<span class="type">Key</span>: <span class="type">Weak</span>&lt;<span class="type">Value</span>&gt;] <span class="operator">=</span> [:]</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 下标访问</span></span><br><span class="line">    <span class="keyword">subscript</span>(<span class="params">key</span>: <span class="type">Key</span>) -&gt; <span class="type">Value</span>? &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> dictionary[key]<span class="operator">?</span>.value</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> newValue <span class="operator">=</span> newValue &#123;</span><br><span class="line">                dictionary[key] <span class="operator">=</span> <span class="type">Weak</span>(value: newValue)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                dictionary.removeValue(forKey: key)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 清理已销毁的弱引用</span></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">clean</span>() &#123;</span><br><span class="line">        dictionary <span class="operator">=</span> dictionary.filter &#123; <span class="variable">$0</span>.value.value <span class="operator">!=</span> <span class="literal">nil</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 所有有效键值对</span></span><br><span class="line">    <span class="keyword">var</span> validPairs: [(<span class="type">Key</span>, <span class="type">Value</span>)] &#123;</span><br><span class="line">        clean()</span><br><span class="line">        <span class="keyword">return</span> dictionary.compactMap &#123; (key, weakValue) <span class="keyword">in</span></span><br><span class="line">            weakValue.value.map &#123; (key, <span class="variable">$0</span>) &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">let</span> weakDict <span class="operator">=</span> <span class="type">WeakValueDictionary</span>&lt;<span class="type">String</span>, <span class="type">Observer</span>&gt;()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加键值对</span></span><br><span class="line">weakDict[<span class="string">&quot;observer1&quot;</span>] <span class="operator">=</span> <span class="type">Observer</span>(name: <span class="string">&quot;字典观察者1&quot;</span>)</span><br><span class="line">weakDict[<span class="string">&quot;observer2&quot;</span>] <span class="operator">=</span> <span class="type">Observer</span>(name: <span class="string">&quot;字典观察者2&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 访问值</span></span><br><span class="line"><span class="built_in">print</span>(weakDict[<span class="string">&quot;observer1&quot;</span>]<span class="operator">?</span>.name <span class="operator">??</span> <span class="string">&quot;不存在&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(weakDict[<span class="string">&quot;observer2&quot;</span>]<span class="operator">?</span>.name <span class="operator">??</span> <span class="string">&quot;不存在&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 清理并获取有效键值对</span></span><br><span class="line"><span class="keyword">for</span> (key, observer) <span class="keyword">in</span> weakDict.validPairs &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;键：<span class="subst">\(key)</span>，值：<span class="subst">\(observer.name)</span>&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1-3-循环引用的高级检测"><a href="#1-3-循环引用的高级检测" class="headerlink" title="1.3 循环引用的高级检测"></a>1.3 循环引用的高级检测</h4><p>使用运行时技术检测循环引用：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个协议，用于检测循环引用</span></span><br><span class="line"><span class="keyword">protocol</span> <span class="title class_">LoopDetection</span>: <span class="title class_ inherited__">AnyObject</span> &#123;</span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">detectLoops</span>() -&gt; [<span class="type">String</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为NSObject扩展实现LoopDetection协议</span></span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">NSObject</span>: <span class="title class_ inherited__">LoopDetection</span> &#123;</span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">detectLoops</span>() -&gt; [<span class="type">String</span>] &#123;</span><br><span class="line">        <span class="keyword">var</span> detectedLoops: [<span class="type">String</span>] <span class="operator">=</span> []</span><br><span class="line">        <span class="keyword">var</span> visited <span class="operator">=</span> <span class="type">Set</span>&lt;<span class="type">ObjectIdentifier</span>&gt;()</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 递归检测循环引用</span></span><br><span class="line">        <span class="keyword">func</span> <span class="title function_">dfs</span>(<span class="keyword">_</span> <span class="params">obj</span>: <span class="type">NSObject</span>, <span class="params">path</span>: [<span class="type">String</span>]) &#123;</span><br><span class="line">            <span class="keyword">let</span> id <span class="operator">=</span> <span class="type">ObjectIdentifier</span>(obj)</span><br><span class="line">            <span class="keyword">if</span> visited.contains(id) &#123;</span><br><span class="line">                <span class="comment">// 找到循环引用</span></span><br><span class="line">                <span class="keyword">let</span> loopPath <span class="operator">=</span> path <span class="operator">+</span> [<span class="type">String</span>(describing: obj)]</span><br><span class="line">                detectedLoops.append(<span class="string">&quot;循环引用路径：<span class="subst">\(loopPath.joined(separator: <span class="string">&quot; -&gt; &quot;</span>))</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            visited.insert(id)</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 遍历所有属性</span></span><br><span class="line">            <span class="keyword">var</span> count: <span class="type">UInt32</span> <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">            <span class="keyword">let</span> properties <span class="operator">=</span> class_copyPropertyList(<span class="built_in">type</span>(of: obj), <span class="operator">&amp;</span>count)</span><br><span class="line">            <span class="keyword">defer</span> &#123; free(properties) &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span><span class="operator">..&lt;</span><span class="type">Int</span>(count) &#123;</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">let</span> property <span class="operator">=</span> properties<span class="operator">?</span>[i],</span><br><span class="line">                   <span class="keyword">let</span> propertyName <span class="operator">=</span> <span class="type">NSString</span>(utf8String: property_getName(property)) <span class="keyword">as</span> <span class="type">String</span>? &#123;</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 获取属性值</span></span><br><span class="line">                    <span class="keyword">let</span> value <span class="operator">=</span> obj.value(forKey: propertyName)</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 如果是NSObject类型，继续检测</span></span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">let</span> childObj <span class="operator">=</span> value <span class="keyword">as?</span> <span class="type">NSObject</span> &#123;</span><br><span class="line">                        dfs(childObj, path: path <span class="operator">+</span> [propertyName])</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            visited.remove(id)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        dfs(<span class="keyword">self</span>, path: [<span class="type">String</span>(describing: <span class="built_in">type</span>(of: <span class="keyword">self</span>))])</span><br><span class="line">        <span class="keyword">return</span> detectedLoops</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>: <span class="title class_ inherited__">NSObject</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> name: <span class="type">String</span></span><br><span class="line">    <span class="keyword">var</span> friend: <span class="type">Person</span>?</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(<span class="params">name</span>: <span class="type">String</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.name <span class="operator">=</span> name</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建循环引用</span></span><br><span class="line"><span class="keyword">let</span> alice <span class="operator">=</span> <span class="type">Person</span>(name: <span class="string">&quot;Alice&quot;</span>)</span><br><span class="line"><span class="keyword">let</span> bob <span class="operator">=</span> <span class="type">Person</span>(name: <span class="string">&quot;Bob&quot;</span>)</span><br><span class="line">alice.friend <span class="operator">=</span> bob</span><br><span class="line">bob.friend <span class="operator">=</span> alice</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检测循环引用</span></span><br><span class="line"><span class="keyword">let</span> loops <span class="operator">=</span> alice.detectLoops()</span><br><span class="line"><span class="keyword">for</span> loop <span class="keyword">in</span> loops &#123;</span><br><span class="line">    <span class="built_in">print</span>(loop)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-内存优化策略"><a href="#2-内存优化策略" class="headerlink" title="2. 内存优化策略"></a>2. 内存优化策略</h3><h4 id="2-1-懒加载与预加载结合"><a href="#2-1-懒加载与预加载结合" class="headerlink" title="2.1 懒加载与预加载结合"></a>2.1 懒加载与预加载结合</h4><p>根据应用场景选择合适的加载策略：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ImageManager</span> &#123;</span><br><span class="line">    <span class="comment">// 小图片预加载</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">let</span> smallImages: [<span class="type">String</span>: <span class="type">UIImage</span>] <span class="operator">=</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> imageNames <span class="operator">=</span> [<span class="string">&quot;icon1&quot;</span>, <span class="string">&quot;icon2&quot;</span>, <span class="string">&quot;icon3&quot;</span>]</span><br><span class="line">        <span class="keyword">var</span> images: [<span class="type">String</span>: <span class="type">UIImage</span>] <span class="operator">=</span> [:]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> name <span class="keyword">in</span> imageNames &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> image <span class="operator">=</span> <span class="type">UIImage</span>(named: name) &#123;</span><br><span class="line">                images[name] <span class="operator">=</span> image</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> images</span><br><span class="line">    &#125;()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 大图片懒加载</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> largeImages: [<span class="type">String</span>: <span class="type">UIImage</span>] <span class="operator">=</span> [:]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">getImage</span>(<span class="params">named</span> <span class="params">name</span>: <span class="type">String</span>, <span class="params">isLarge</span>: <span class="type">Bool</span>) -&gt; <span class="type">UIImage</span>? &#123;</span><br><span class="line">        <span class="keyword">if</span> isLarge &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> image <span class="operator">=</span> largeImages[name] &#123;</span><br><span class="line">                <span class="keyword">return</span> image</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">let</span> image <span class="operator">=</span> <span class="type">UIImage</span>(named: name) &#123;</span><br><span class="line">                largeImages[name] <span class="operator">=</span> image</span><br><span class="line">                <span class="keyword">return</span> image</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> smallImages[name]</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 清理大图片缓存</span></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">clearLargeImageCache</span>() &#123;</span><br><span class="line">        largeImages.removeAll()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-2-内存警告处理"><a href="#2-2-内存警告处理" class="headerlink" title="2.2 内存警告处理"></a>2.2 内存警告处理</h4><p>响应系统内存警告，释放不必要的资源：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DataCache</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> cache: [<span class="type">String</span>: <span class="type">Data</span>] <span class="operator">=</span> [:]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>() &#123;</span><br><span class="line">        <span class="comment">// 监听内存警告通知</span></span><br><span class="line">        <span class="type">NotificationCenter</span>.default.addObserver(</span><br><span class="line">            <span class="keyword">self</span>,</span><br><span class="line">            selector: <span class="keyword">#selector</span>(handleMemoryWarning),</span><br><span class="line">            name: <span class="type">UIApplication</span>.didReceiveMemoryWarningNotification,</span><br><span class="line">            object: <span class="literal">nil</span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">cache</span>(<span class="keyword">_</span> <span class="params">data</span>: <span class="type">Data</span>, <span class="params">forKey</span> <span class="params">key</span>: <span class="type">String</span>) &#123;</span><br><span class="line">        cache[key] <span class="operator">=</span> data</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">getData</span>(<span class="params">forKey</span> <span class="params">key</span>: <span class="type">String</span>) -&gt; <span class="type">Data</span>? &#123;</span><br><span class="line">        <span class="keyword">return</span> cache[key]</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">@objc</span> <span class="keyword">private</span> <span class="keyword">func</span> <span class="title function_">handleMemoryWarning</span>() &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;收到内存警告，清理缓存&quot;</span>)</span><br><span class="line">        <span class="comment">// 清理部分或全部缓存</span></span><br><span class="line">        cache.removeAll()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">deinit</span> &#123;</span><br><span class="line">        <span class="type">NotificationCenter</span>.default.removeObserver(<span class="keyword">self</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-3-内存泄漏检测工具的高级使用"><a href="#2-3-内存泄漏检测工具的高级使用" class="headerlink" title="2.3 内存泄漏检测工具的高级使用"></a>2.3 内存泄漏检测工具的高级使用</h4><p>使用Instruments进行高级内存泄漏检测：</p>
<ol>
<li><p><strong>Allocations工具</strong>：</p>
<ul>
<li>跟踪内存分配情况</li>
<li>识别内存增长趋势</li>
<li>查找内存泄漏的对象</li>
</ul>
</li>
<li><p><strong>Leaks工具</strong>：</p>
<ul>
<li>自动检测内存泄漏</li>
<li>显示泄漏对象的调用栈</li>
<li>提供修复建议</li>
</ul>
</li>
<li><p><strong>VM Tracker工具</strong>：</p>
<ul>
<li>分析虚拟内存使用情况</li>
<li>识别内存压力来源</li>
</ul>
</li>
<li><p><strong>Zombies工具</strong>：</p>
<ul>
<li>检测野指针访问</li>
<li>显示对象被释放后的访问情况</li>
</ul>
</li>
</ol>
<h3 id="3-性能优化最佳实践"><a href="#3-性能优化最佳实践" class="headerlink" title="3. 性能优化最佳实践"></a>3. 性能优化最佳实践</h3><ol>
<li><p><strong>值类型与引用类型的选择</strong>：</p>
<ul>
<li>优先使用值类型（结构体、枚举）存储简单数据</li>
<li>只有在需要继承或引用语义时使用类</li>
</ul>
</li>
<li><p><strong>引用类型的最佳实践</strong>：</p>
<ul>
<li>使用弱引用或无主引用打破循环引用</li>
<li>在委托模式中使用弱引用委托</li>
<li>在闭包中使用捕获列表避免循环引用</li>
</ul>
</li>
<li><p><strong>内存管理的自动化</strong>：</p>
<ul>
<li>使用自动引用计数（ARC），避免手动内存管理</li>
<li>利用<code>deinit</code>方法清理资源</li>
<li>响应内存警告，释放不必要的资源</li>
</ul>
</li>
<li><p><strong>性能监控与调试</strong>：</p>
<ul>
<li>定期使用Instruments检测内存泄漏</li>
<li>监控应用的内存使用情况</li>
<li>分析内存增长趋势，识别性能瓶颈</li>
</ul>
</li>
<li><p><strong>高级内存优化</strong>：</p>
<ul>
<li>实现高效的缓存策略</li>
<li>使用对象池减少对象创建销毁开销</li>
<li>优化大型数据结构的内存使用</li>
</ul>
</li>
</ol>
<h2 id="十一、实践练习"><a href="#十一、实践练习" class="headerlink" title="十一、实践练习"></a>十一、实践练习</h2><h3 id="1-内存管理基础练习"><a href="#1-内存管理基础练习" class="headerlink" title="1. 内存管理基础练习"></a>1. 内存管理基础练习</h3><h4 id="1-1-强引用与弱引用实践"><a href="#1-1-强引用与弱引用实践" class="headerlink" title="1.1 强引用与弱引用实践"></a>1.1 强引用与弱引用实践</h4><p>创建一个<code>Person</code>类和一个<code>Apartment</code>类，实现以下功能：</p>
<ol>
<li><code>Person</code>类有<code>name</code>属性和<code>apartment</code>属性</li>
<li><code>Apartment</code>类有<code>unit</code>属性和<code>tenant</code>属性</li>
<li>先使用强引用创建循环引用，演示内存泄漏</li>
<li>然后使用弱引用打破循环引用，确保对象能被正确销毁</li>
<li>使用<code>deinit</code>方法验证对象是否被销毁</li>
</ol>
<h4 id="1-2-闭包循环引用实践"><a href="#1-2-闭包循环引用实践" class="headerlink" title="1.2 闭包循环引用实践"></a>1.2 闭包循环引用实践</h4><p>创建一个<code>Logger</code>类，实现以下功能：</p>
<ol>
<li>有一个<code>log</code>数组用于存储日志消息</li>
<li>有一个<code>processLog</code>闭包属性，用于处理日志</li>
<li>在<code>init</code>方法中初始化闭包，使其引用<code>self</code></li>
<li>演示循环引用导致的内存泄漏</li>
<li>使用捕获列表解决循环引用问题</li>
</ol>
<h3 id="2-高级内存管理练习"><a href="#2-高级内存管理练习" class="headerlink" title="2. 高级内存管理练习"></a>2. 高级内存管理练习</h3><h4 id="2-1-实现弱引用数组"><a href="#2-1-实现弱引用数组" class="headerlink" title="2.1 实现弱引用数组"></a>2.1 实现弱引用数组</h4><p>创建一个<code>WeakArray</code>类，实现以下功能：</p>
<ol>
<li>能存储任意类类型的弱引用</li>
<li>自动清理已销毁的对象</li>
<li>提供<code>append</code>、<code>remove</code>、<code>count</code>等基本操作</li>
<li>实现<code>subscript</code>下标访问</li>
<li>演示在观察者模式中的应用</li>
</ol>
<h4 id="2-2-实现弱引用字典"><a href="#2-2-实现弱引用字典" class="headerlink" title="2.2 实现弱引用字典"></a>2.2 实现弱引用字典</h4><p>创建一个<code>WeakValueDictionary</code>类，实现以下功能：</p>
<ol>
<li>键是强引用，值是弱引用</li>
<li>自动清理值已销毁的键值对</li>
<li>提供标准字典的基本操作（<code>subscript</code>、<code>removeValue</code>等）</li>
<li>实现<code>clean()</code>方法手动清理无效条目</li>
<li>演示在缓存场景中的应用</li>
</ol>
<h3 id="3-综合应用练习"><a href="#3-综合应用练习" class="headerlink" title="3. 综合应用练习"></a>3. 综合应用练习</h3><h4 id="3-1-实现自动清理的缓存"><a href="#3-1-实现自动清理的缓存" class="headerlink" title="3.1 实现自动清理的缓存"></a>3.1 实现自动清理的缓存</h4><p>创建一个<code>AutoCleaningCache</code>类，实现以下功能：</p>
<ol>
<li>基于<code>WeakValueDictionary</code>存储缓存数据</li>
<li>提供<code>set</code>、<code>get</code>、<code>remove</code>、<code>clear</code>等方法</li>
<li>实现LRU（最近最少使用）淘汰策略</li>
<li>监听系统内存警告，自动清理部分或全部缓存</li>
<li>使用<code>deinit</code>方法确保资源正确释放</li>
</ol>
<h4 id="3-2-实现观察者模式"><a href="#3-2-实现观察者模式" class="headerlink" title="3.2 实现观察者模式"></a>3.2 实现观察者模式</h4><p>创建一个<code>Subject</code>协议和<code>Observer</code>协议，实现以下功能：</p>
<ol>
<li><code>Subject</code>能添加、移除和通知观察者</li>
<li>使用<code>WeakArray</code>存储观察者，避免内存泄漏</li>
<li>实现具体的<code>NewsPublisher</code>和<code>NewsSubscriber</code>类</li>
<li>演示订阅、发布和自动取消订阅的流程</li>
<li>验证所有对象都能被正确销毁</li>
</ol>
<h2 id="十二、总结"><a href="#十二、总结" class="headerlink" title="十二、总结"></a>十二、总结</h2><p>在这篇学习日记中，我们深入探讨了Swift的内存管理机制：</p>
<ol>
<li><p><strong>基本概念</strong>：内存管理涉及堆内存与栈内存、值类型与引用类型、对象的生命周期等概念。</p>
</li>
<li><p><strong>自动引用计数（ARC）</strong>：Swift使用ARC机制来管理类实例的内存，自动跟踪和管理对象的引用计数。</p>
</li>
<li><p><strong>引用类型</strong>：包括强引用、弱引用和无主引用：</p>
<ul>
<li><strong>强引用</strong>：默认的引用类型，会增加对象的引用计数</li>
<li><strong>弱引用</strong>：不会增加对象的引用计数，用于解决循环引用，对象被销毁时会自动变为nil</li>
<li><strong>无主引用</strong>：不会增加对象的引用计数，用于解决循环引用，对象被销毁时不会自动变为nil</li>
</ul>
</li>
<li><p><strong>循环引用</strong>：</p>
<ul>
<li>类实例之间的循环引用：使用弱引用或无主引用解决</li>
<li>闭包与类实例之间的循环引用：使用捕获列表解决</li>
</ul>
</li>
<li><p><strong>最佳实践</strong>：</p>
<ul>
<li>优先使用值类型</li>
<li>避免不必要的强引用</li>
<li>及时清理资源</li>
<li>使用内存分析工具</li>
<li>避免保留周期</li>
</ul>
</li>
</ol>
<p>内存管理是Swift编程中的重要组成部分，它直接影响应用的性能和稳定性。掌握Swift的内存管理机制，特别是自动引用计数和循环引用的解决方法，对于开发高质量的iOS应用至关重要。在下一篇学习日记中，我们将总结Swift的核心概念，并展望Swift的未来发展。</p>

  </div>
  <!--文末结束语-->
  
    <div style="text-align:center;color: #ccc;font-size:24px;"> --- 本文结束 <i class="iconfont icon-heartbeat" style="font-size:24px;"></i> The End --- </div>
  
  <!--页脚广告-->
  
  <div class="mdui-divider"></div>
  
  <nav>
    
      <a rel="prev" class="post-nav-item mdui-float-left" href="/ios.github.io/2025/12/16/swift%E5%AD%A6%E4%B9%A0%E6%97%A5%E8%AE%B0%EF%BC%88%E5%8D%81%EF%BC%89/">
        <i class="iconfont icon-angle-left"></i>
        <span>swift学习日记(十)</span>
      </a>
    
    
      <a rel="next" class="post-nav-item mdui-float-right" href="/ios.github.io/2025/12/12/swift%E5%AD%A6%E4%B9%A0%E6%97%A5%E8%AE%B0%EF%BC%88%E5%85%AB%EF%BC%89/">
        <span>swift学习日记(八)</span>
        <i class="iconfont icon-angle-right"></i>
      </a>
    
  </nav>
</article>




  <div class="toc-button"  style="z-index: 100;">
    <button class="mdui-fab mdui-ripple mdui-color-teal" mdui-menu="{target: '#toc'}"><i class="iconfont icon-list"></i></button>
    <ul class="mdui-menu" id="toc">
      <li class="mdui-menu-item">
        <a href="/ios.github.io/2025/12/14/swift%E5%AD%A6%E4%B9%A0%E6%97%A5%E8%AE%B0%EF%BC%88%E4%B9%9D%EF%BC%89/" id="toc-header" class="mdui-ripple">文章目录</a>
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Swift%E5%AD%A6%E4%B9%A0%E6%97%A5%E8%AE%B0%EF%BC%88%E4%B9%9D%EF%BC%89%EF%BC%9A%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86"><span class="toc-number">1.</span> <span class="toc-text">Swift学习日记（九）：内存管理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%BC%95%E8%A8%80"><span class="toc-number">1.1.</span> <span class="toc-text">一、引言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">1.2.</span> <span class="toc-text">二、内存管理的基本概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E8%87%AA%E5%8A%A8%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0%EF%BC%88ARC%EF%BC%89"><span class="toc-number">1.3.</span> <span class="toc-text">三、自动引用计数（ARC）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-ARC%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">1.3.1.</span> <span class="toc-text">1. ARC的工作原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-ARC%E7%9A%84%E5%9F%BA%E6%9C%AC%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.3.2.</span> <span class="toc-text">2. ARC的基本示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.4.</span> <span class="toc-text">四、引用类型的引用类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%BC%BA%E5%BC%95%E7%94%A8"><span class="toc-number">1.4.1.</span> <span class="toc-text">1. 强引用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%BC%B1%E5%BC%95%E7%94%A8"><span class="toc-number">1.4.2.</span> <span class="toc-text">2. 弱引用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%97%A0%E4%B8%BB%E5%BC%95%E7%94%A8"><span class="toc-number">1.4.3.</span> <span class="toc-text">3. 无主引用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E5%BE%AA%E7%8E%AF%E5%BC%95%E7%94%A8"><span class="toc-number">1.5.</span> <span class="toc-text">五、循环引用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E7%B1%BB%E5%AE%9E%E4%BE%8B%E4%B9%8B%E9%97%B4%E7%9A%84%E5%BE%AA%E7%8E%AF%E5%BC%95%E7%94%A8"><span class="toc-number">1.5.1.</span> <span class="toc-text">1. 类实例之间的循环引用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E9%97%AD%E5%8C%85%E4%B8%8E%E7%B1%BB%E5%AE%9E%E4%BE%8B%E4%B9%8B%E9%97%B4%E7%9A%84%E5%BE%AA%E7%8E%AF%E5%BC%95%E7%94%A8"><span class="toc-number">1.5.2.</span> <span class="toc-text">2. 闭包与类实例之间的循环引用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%8D%95%E8%8E%B7%E5%88%97%E8%A1%A8%E7%9A%84%E8%AF%AD%E6%B3%95"><span class="toc-number">1.5.3.</span> <span class="toc-text">3. 捕获列表的语法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E9%97%AD%E5%8C%85%E4%B8%AD%E7%9A%84self"><span class="toc-number">1.5.4.</span> <span class="toc-text">4. 闭包中的self</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.6.</span> <span class="toc-text">六、内存管理的最佳实践</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%BC%98%E5%85%88%E4%BD%BF%E7%94%A8%E5%80%BC%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.6.1.</span> <span class="toc-text">1. 优先使用值类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E9%81%BF%E5%85%8D%E4%B8%8D%E5%BF%85%E8%A6%81%E7%9A%84%E5%BC%BA%E5%BC%95%E7%94%A8"><span class="toc-number">1.6.2.</span> <span class="toc-text">2. 避免不必要的强引用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A7%94%E6%89%98%E6%A8%A1%E5%BC%8F%E4%B8%AD%E7%9A%84%E5%BC%B1%E5%BC%95%E7%94%A8"><span class="toc-number">1.6.2.1.</span> <span class="toc-text">委托模式中的弱引用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%8F%8A%E6%97%B6%E6%B8%85%E7%90%86%E8%B5%84%E6%BA%90"><span class="toc-number">1.6.3.</span> <span class="toc-text">3. 及时清理资源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E4%BD%BF%E7%94%A8%E5%86%85%E5%AD%98%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7"><span class="toc-number">1.6.4.</span> <span class="toc-text">4. 使用内存分析工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E9%81%BF%E5%85%8D%E4%BF%9D%E7%95%99%E5%91%A8%E6%9C%9F"><span class="toc-number">1.6.5.</span> <span class="toc-text">5. 避免保留周期</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E7%9A%84%E9%AB%98%E7%BA%A7%E8%AF%9D%E9%A2%98"><span class="toc-number">1.7.</span> <span class="toc-text">七、内存管理的高级话题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E8%87%AA%E5%8A%A8%E9%87%8A%E6%94%BE%E6%B1%A0"><span class="toc-number">1.7.1.</span> <span class="toc-text">1. 自动释放池</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%BC%B1%E5%BC%95%E7%94%A8%E6%95%B0%E7%BB%84"><span class="toc-number">1.7.2.</span> <span class="toc-text">2. 弱引用数组</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%BB%B6%E8%BF%9F%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">1.7.3.</span> <span class="toc-text">3. 延迟初始化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB%E3%80%81%E5%86%85%E5%AE%B9%E6%9C%BA%E5%88%B6%E4%B8%8E%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93"><span class="toc-number">1.8.</span> <span class="toc-text">八、内容机制与知识点总结</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Swift%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E7%9A%84%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99"><span class="toc-number">1.8.1.</span> <span class="toc-text">1. Swift内存管理的设计原则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%A0%B8%E5%BF%83%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93"><span class="toc-number">1.8.2.</span> <span class="toc-text">2. 核心知识点总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B9%9D%E3%80%81%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">1.9.</span> <span class="toc-text">九、遇到的问题及解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%BE%AA%E7%8E%AF%E5%BC%95%E7%94%A8%E5%AF%BC%E8%87%B4%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F"><span class="toc-number">1.9.1.</span> <span class="toc-text">1. 循环引用导致内存泄漏</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E9%97%AD%E5%8C%85%E4%B8%8E%E5%AE%9E%E4%BE%8B%E7%9A%84%E5%BE%AA%E7%8E%AF%E5%BC%95%E7%94%A8"><span class="toc-number">1.9.2.</span> <span class="toc-text">2. 闭包与实例的循环引用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%A7%94%E6%89%98%E6%A8%A1%E5%BC%8F%E4%B8%AD%E7%9A%84%E5%BE%AA%E7%8E%AF%E5%BC%95%E7%94%A8"><span class="toc-number">1.9.3.</span> <span class="toc-text">3. 委托模式中的循环引用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%BC%BA%E5%BC%95%E7%94%A8%E5%BE%AA%E7%8E%AF%E5%9C%A8%E5%BB%B6%E8%BF%9F%E5%B1%9E%E6%80%A7%E4%B8%AD"><span class="toc-number">1.9.4.</span> <span class="toc-text">4. 强引用循环在延迟属性中</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E4%B8%8D%E6%AD%A3%E7%A1%AE%E4%BD%BF%E7%94%A8%E6%97%A0%E4%B8%BB%E5%BC%95%E7%94%A8%E5%AF%BC%E8%87%B4%E5%B4%A9%E6%BA%83"><span class="toc-number">1.9.5.</span> <span class="toc-text">5. 不正确使用无主引用导致崩溃</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E3%80%81%E9%AB%98%E9%98%B6%E7%94%A8%E6%B3%95"><span class="toc-number">1.10.</span> <span class="toc-text">十、高阶用法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E9%AB%98%E7%BA%A7%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%8A%80%E5%B7%A7"><span class="toc-number">1.10.1.</span> <span class="toc-text">1. 高级内存管理技巧</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-%E5%BC%B1%E5%BC%95%E7%94%A8%E6%95%B0%E7%BB%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.10.1.1.</span> <span class="toc-text">1.1 弱引用数组实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-%E5%BC%B1%E5%BC%95%E7%94%A8%E5%AD%97%E5%85%B8%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.10.1.2.</span> <span class="toc-text">1.2 弱引用字典实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-%E5%BE%AA%E7%8E%AF%E5%BC%95%E7%94%A8%E7%9A%84%E9%AB%98%E7%BA%A7%E6%A3%80%E6%B5%8B"><span class="toc-number">1.10.1.3.</span> <span class="toc-text">1.3 循环引用的高级检测</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%86%85%E5%AD%98%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5"><span class="toc-number">1.10.2.</span> <span class="toc-text">2. 内存优化策略</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E6%87%92%E5%8A%A0%E8%BD%BD%E4%B8%8E%E9%A2%84%E5%8A%A0%E8%BD%BD%E7%BB%93%E5%90%88"><span class="toc-number">1.10.2.1.</span> <span class="toc-text">2.1 懒加载与预加载结合</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E5%86%85%E5%AD%98%E8%AD%A6%E5%91%8A%E5%A4%84%E7%90%86"><span class="toc-number">1.10.2.2.</span> <span class="toc-text">2.2 内存警告处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E6%A3%80%E6%B5%8B%E5%B7%A5%E5%85%B7%E7%9A%84%E9%AB%98%E7%BA%A7%E4%BD%BF%E7%94%A8"><span class="toc-number">1.10.2.3.</span> <span class="toc-text">2.3 内存泄漏检测工具的高级使用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.10.3.</span> <span class="toc-text">3. 性能优化最佳实践</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E4%B8%80%E3%80%81%E5%AE%9E%E8%B7%B5%E7%BB%83%E4%B9%A0"><span class="toc-number">1.11.</span> <span class="toc-text">十一、实践练习</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E5%9F%BA%E7%A1%80%E7%BB%83%E4%B9%A0"><span class="toc-number">1.11.1.</span> <span class="toc-text">1. 内存管理基础练习</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-%E5%BC%BA%E5%BC%95%E7%94%A8%E4%B8%8E%E5%BC%B1%E5%BC%95%E7%94%A8%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.11.1.1.</span> <span class="toc-text">1.1 强引用与弱引用实践</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-%E9%97%AD%E5%8C%85%E5%BE%AA%E7%8E%AF%E5%BC%95%E7%94%A8%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.11.1.2.</span> <span class="toc-text">1.2 闭包循环引用实践</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E9%AB%98%E7%BA%A7%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E7%BB%83%E4%B9%A0"><span class="toc-number">1.11.2.</span> <span class="toc-text">2. 高级内存管理练习</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E5%AE%9E%E7%8E%B0%E5%BC%B1%E5%BC%95%E7%94%A8%E6%95%B0%E7%BB%84"><span class="toc-number">1.11.2.1.</span> <span class="toc-text">2.1 实现弱引用数组</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E5%AE%9E%E7%8E%B0%E5%BC%B1%E5%BC%95%E7%94%A8%E5%AD%97%E5%85%B8"><span class="toc-number">1.11.2.2.</span> <span class="toc-text">2.2 实现弱引用字典</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E7%BB%BC%E5%90%88%E5%BA%94%E7%94%A8%E7%BB%83%E4%B9%A0"><span class="toc-number">1.11.3.</span> <span class="toc-text">3. 综合应用练习</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%8A%A8%E6%B8%85%E7%90%86%E7%9A%84%E7%BC%93%E5%AD%98"><span class="toc-number">1.11.3.1.</span> <span class="toc-text">3.1 实现自动清理的缓存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-%E5%AE%9E%E7%8E%B0%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.11.3.2.</span> <span class="toc-text">3.2 实现观察者模式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E4%BA%8C%E3%80%81%E6%80%BB%E7%BB%93"><span class="toc-number">1.12.</span> <span class="toc-text">十二、总结</span></a></li></ol></li></ol>
      </li>
    </ul>
  </div>



    <div id="comment" class="mdui-card mdui-p-a-2 mdui-m-b-5">
      <div class="mdui-tab" mdui-tab>
        
          <a href="#comment-tab0" class="mdui-ripple">gitalk</a>
        
          <a href="#comment-tab1" class="mdui-ripple">livere</a>
        
      </div>
      
        <div id="comment-tab0" class="mdui-p-a-2">
          <div id="gitalk-container"></div>
<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<script src="//cdn.jsdelivr.net/npm/js-md5@0.7.3/src/md5.min.js"></script>
<script>
  var gitalk = new Gitalk({
    clientID: '',
    clientSecret: '',
    repo: '',
    owner: '',
    admin: [''],
    id:  md5(location.pathname) ,
    distractionFreeMode: 'true',
  });
  gitalk.render('gitalk-container');
</script>
        </div>
      
        <div id="comment-tab1" class="mdui-p-a-2">
          <div id="lv-container" data-id="city" data-uid="">
  <script type="text/javascript">
    (function (d, s) {
      var j, e = d.getElementsByTagName(s)[0];
      if (typeof LivereTower === 'function') { return; }
      j = d.createElement(s);
      j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
      j.async = true;
      e.parentNode.insertBefore(j, e);
    })(document, 'script');
  </script>
  <noscript>Please enable JavaScript to view the comments powered by LiveRe.</noscript>
</div>
        </div>
      
    </div>

  </main>
  <footer id="footer" class="mdui-text-center mdui-m-t-5 mdui-p-b-2 mdui-p-t-4 mdui-color-theme">
  <div class="mdui-container">
    <div class="mdui-row">
      
      <span>
        &copy; 2025 - 2025 
        
        猪会飞
      </span>
    </div>
    <div class="mdui-row">
      
        <span>Theme: <a href="https://github.com/kb1000fx/hexo-theme-meadow" rel="noopener" target="_blank">Meadow</a></span>
      
    </div>
    <div class="mdui-row">
      
    </div>
 </div>
</footer>
  
  <button id="gotop" class="mdui-fab mdui-fab-fixed mdui-fab-hide mdui-ripple mdui-color-teal" style="z-index:100;"><i class="iconfont icon-arrowup"></i></button>
  
  




    <script src="https://cdn.jsdelivr.net/npm/mermaid@8.4.8/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({
        startOnLoad: true,
        theme: "default"
    });</script>




    
<script src="/ios.github.io/js/mdui.min.v1.0.0.js"></script>




<script src="/ios.github.io/js/meadow.js"></script>

</body>
</html >